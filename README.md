# FPGA Demo for Simmani with Hwacha-Net

This repo demonstrates the case study of the Simmani MICRO paper. The power model(`model.tsmc45.csv`) was trained with the implementation in [simmani](https://github.com/Simmani/simmani.git).

## <a name="chapter1"></a> Section 1: Compiling the FPGA-based Simulator

This step explains how to compile the FPGA-based simulator and generate its AFI. This may take 5~6 hours, and thus, you may skip to [Section 2](#section2) to run the FPGA-based simulator with the pre-generated AFI.

### Step 1-1: Getting Started

* Launch an `c4.x8large` or `c5.x9large` instance with [FPGA Developer AMI v1.5.0 (Oct 01, 2018)](https://aws.amazon.com/marketplace/pp/B06VVYBLZZ) (ami-0da0d9ed98b33a214). We recommend US East(N. Virginia) for the region and 300GB for the root storage.
* Configure the instance.
```
$ aws configure
AWS Access Key ID [None]: <your key>
AWS Secret Access Key [None]: <your secret key>
Default region name [None]: us-east-1
Default output format [None]: json
```
* Initialize this repo.
```
git clone https://github.com/Simmani/fpga-demo.git
cd fpga-demo
./setup.sh
```

### Step 1-2: Generating Verilog
```
scons fpga-v
```

### Step 1-3: (Optional) Running Tests
```
scons verilator       # Warning: this may take tens of minutes
scons run-asm-tests   # Run assembly tests
scons run-bmark-tests # Run microbenchmarks
```

### Step 1-4: Generating Bitstream
```
export EMAIL=<your email address> # To recieve notification
source sourceme-f1.sh
scons fpga
```
This may take 4~5 hours. You'll be notified by email when this is done.

### Step 1-5: Creating the AFI
```
scons bucket=<your S3 bucket name> [name=<AFI name>]
...
{
    "FpgaImageId": "afi-010e71c45e10b9afb",
    "FpgaImageGlobalId": "agfi-033d1f2bff292a5b7"
}
```
This may take ~1 hour. It's important keep both `FpgaImageId` and `FpgaImageGlobalId`. To check the status, run:
```
aws ec2 describe-fpga-images --fpga-image-ids <FpgaImageId>
```
You're ready for [Section 2](#section2) with your own AFI when `State` becomes `available`.

## <a name="section2"></a> Section 2: Running SqueezeNet on Hwacha with the FPGA-based simulator

This step explains how to run SqueezeNet on hwacha and generate its runtime power traces. Even though [esp-tools-prebuilt](https://github.com/Simmani/esp-tools-prebuilt) only contains SqueezeNet binaries, you can run other workloads using bianries generated by [workloads](https://github.com/Simmani/workloads).

### Step 2-1: Getting Started

* Launch an `f1.x2large` instance with [FPGA Developer AMI v1.5.0 (Oct 01, 2018)](https://aws.amazon.com/marketplace/pp/B06VVYBLZZ) (ami-0da0d9ed98b33a214). We recommend US East(N. Virginia) for the region and 300GB for the root storage.
* Initialize this repo.
```
git clone https://github.com/Simmani/fpga-demo.git
cd fpga-demo
./setup.sh
```

### Step 2-2: Generating the Header File
```
scons fpga-v
```

### Step 2-3: Compiling the Simulation Driver
```
source sourceme-f1.sh
scons f1
```

### Step 2-4: Running FPGA-based Simulation
```
scons run=<binary> [agfi=<FpgaImageGlobalId>]
```
`<binary>` can be any binary filename in `/home/centos/riscv/bin` or an absolute path. If you don't provide `<FpgaImageGlobalId>`, it will use the pre-pregenerated AFI.

You can run SqueezeNet workloads as follows:
```
scons run=~/riscv/bin/bblvmlinux-squeezenet_32 [agfi=<FpgaImageGlobalId>]        # vectorized SqueezeNet
scons run=bblvmlinux-squeezenet_encoded_32 [agfi=<FpgaImageGlobalId>]            # vectorized SqueezeNet-8bits
scons run=bblvmlinux-squeezenet_encoded_compressed_32 [agfi=<FpgaImageGlobalId>] # vectorized SqueezeNet-comp
```
Power traces are available in `output/<binary>`.

## Publications

* Donggyu Kim, Jerry Zhao, Jonathan Bachrach, and Krste AsanoviÄ‡, **"Simmani: Runtime Power Modeling for Arbitrary RTL with Automatic Signal Selection"**, In proceedings of the 52nd IEEE/ACM International Symposium on Microarchitecture (MICRO'19), Columbus, OH, October 2019.
* Donggyu Kim, **"FPGA-Accelerated Evaluation and Verification of RTL Designs"**, Ph.D. Thesis, University of California, Berkeley, May 2019.
